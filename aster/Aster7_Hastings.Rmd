---
title: "Aster7_Hastings"
author: "Helen Payne"
date: "2025-07-29"
output: html_document
---

#Hastings Ranch
##Generation 1 2022
```{r}
library(tidyverse)
library(readr)
library(dplyr)
library(stringr)
library(here)

HR_22 <- read_csv(here::here("Desktop/nemo_field/data_sheets/compiled_sheets/HR_mastersheet_full_2022.csv")) %>%
  rename_at(vars(55), ~"surv_to_fruitpod") %>%
  mutate(
    # Construct sample_ID conditionally
    sample_ID = str_c(Year, Recipient, Gen, str_pad(Transect, width = 3, pad = "0"), Plant_ID, sep = "-"),
    # Replace leading underscores in sample_ID with hyphens
    sample_ID = str_replace(sample_ID, "^([^_]*)_", "\\1-")
  ) %>%
  dplyr::select("Transect", "Donor", "Recipient", "sample_ID", "surv_to_flower", "F_plant", "total_fruits", "closed_fruits", "filled_seeds") %>%
  mutate(F_plant = ifelse(F_plant == TRUE, 1, 0))%>%
  filter(!(Transect %in% c("W1", "W2"))) %>%
  mutate(surv_to_flower = ifelse(total_fruits > 0 & surv_to_flower == 0, 1, surv_to_flower)) %>%
  mutate(F_plant = ifelse(surv_to_flower == 0, 0, F_plant))
```

```{r}
library(dplyr)

# Create a new column with the first 19 characters of sample_ID
HR_22 <- HR_22 %>%
  mutate(sample_prefix = substr(sample_ID, 1, 19))

# Process each group
HR_22 <- HR_22 %>%
  group_by(sample_prefix) %>%
  mutate(
    # Check if all survival values are 0
    all_dead = all(surv_to_flower == 0),
    # Randomly assign F_plant = 1 to one individual if all are dead
    F_plant = if_else(
      all_dead & row_number() == sample(n(), 1), 
      1L, 
      F_plant
    )
  ) %>%
  ungroup() %>%
  select(-sample_prefix, -all_dead)  # Clean up temporary columns
```